/**
 * locator - In browser locator map generator
 * @version v0.0.1
 * @link https://github.com/datanews/locator#readme
 * @license MIT
 */
!function(){"use strict";var t=function(t){this.options=_.extend({},{template:' <div class="locator {{ (noGenerate.controlsOpen) ? \'controls-open\' : \'controls-closed\' }}">  <section class="locator-display">  <div class="locator-map-wrapper">  <div class="locator-map"></div>   <div class="locator-map-help">  Move the marker by dragging the base.  </div>  </div>  </section>   <div class="toggle-controls" on-tap="toggle:\'noGenerate.controlsOpen\'"></div>   <section class="locator-controls">  <header>Locator</header>   <div class="locator-input">  <div class="config-option">  <label>Marker label</label>  <input type="text" placeholder="Marker label" value="{{ options.markerText }}" lazy>  </div>   {{^options.geocoder}}  <div class="config-option">  <label>Latitude and longitude location</label>   <br><input type="number" placeholder="Latitude" value="{{ options.lat }}" lazy>  <br><input type="number" placeholder="Longitude" value="{{ options.lng }}" lazy>  </div>  {{/options.geocoder}}   {{#options.geocoder}}  <div class="config-option">  <label>Search location by address</label>  <input type="text" placeholder="Address or place" value="{{ geocodeInput }}" lazy disabled="{{ isGeocoding }}">  </div>  {{/options.geocoder}}   {{#(_.size(options.tilesets))}}  <div class="config-option config-select">  <label>Background map set</label>   <select value="{{ options.tileset }}">  {{#options.tilesets:i}}  <option value="{{ i }}">{{ i }}</option>  {{/options.tilesets}}  </select>  </div>  {{/()}}   {{#(_.size(options.widths))}}  <div class="config-option config-select">  <label>Map width</label>   <select value="{{ options.width }}">  {{#options.widths:i}}  <option value="{{ i }}">{{ i }}</option>  {{/options.widths}}  </select>  </div>  {{/()}}   {{#(_.size(options.ratios))}}  <div class="config-option config-select">  <label>Map aspect ratio</label>   <select value="{{ options.ratio }}">  {{#options.ratios:i}}  <option value="{{ i }}">{{ i }}</option>  {{/options.ratios}}  </select>  </div>  {{/()}}   <div class="config-option">  <label>Mini-map zoom</label>   <input type="range" min="-10" max="1" value="{{ options.miniZoomOffset }}" title="Adjust zoom level for map">  </div>   <div class="config-action">  <button class="generate-image" on-click="generate">Generate</button>  </div>   <div class="preview">  <h1>Preview</h1>  <img src="" /><br>  <a href="" class="download-link">Download</a>  </div>  </div>   <footer>  <p>Made by WNYC</p>  </footer>  </section> </div> ',tilesets:{"Mapbox Streets":"http://a.tiles.mapbox.com/v3/jkeefe.np44bm6o/{z}/{x}/{y}.png","Stamen Toner":"http://tile.stamen.com/toner/{z}/{x}/{y}.png"},tileset:"Mapbox Streets",zoom:17,lat:40.74844,lng:-73.98566,minZoom:1,maxZoom:18,miniWidth:"15w",miniHeight:"15w",miniZoomOffset:-6,miniExtentStyles:{fill:!1,stroke:!0,color:"#000000",opacity:.9,weight:4},miniStyles:{backgroundColor:"#FFFFFF",padding:3,shadow:!0,shadowColor:"rgba(0, 0, 0, 0.65)",shadowBlur:5,shadowOffsetX:1,shadowOffsetY:1},markerText:"Empire State Building",markerBackground:"rgba(0, 0, 0, 0.9)",markerForeground:"rgba(255, 255, 255, 0.9)",markerRadius:5,markerFontSize:16,markerFont:'"Open Sans", Helvetica, Arial, sans-serif',markerLabelDistance:20,markerLabelWidth:3,markerPadding:10,widths:{"400px":400,"600px":600,"800px":800},width:"600px",ratios:{"1:1":1,"4:3":4/3,"16:9":16/9},ratio:"4:3",controlsOpen:!0,geocoder:this.defaultGeocoder},t),this.id=_.uniqueId("locator-"),this.el=this.options.el,this.drawInterface()};_.extend(t.prototype,{drawInterface:function(){var t=_.clone(this.options),i={controlsOpen:this.options.controlsOpen};this["interface"]=new Ractive({el:this.options.el,template:this.options.template,data:{options:this.options,noGenerate:i,isGeocoding:!1,geocodeInput:"",_:_}}),this["interface"].on("generate",_.bind(this.generate,this)),this.throttledDrawMaps=_.throttle(_.bind(this.drawMaps,this),1500),_.isFunction(this.options.geocoder)&&(this.throttledGeocoder=_.throttle(_.bind(this.options.geocoder,this),1500)),this["interface"].observe("options",_.bind(function(i){var o=i.lat!==t.lat||i.lng!==t.lng;this.throttledDrawMaps(o),t=_.clone(i)},this),{init:!1}),this["interface"].observe("geocodeInput",_.bind(function(t){_.isFunction(this.throttledGeocoder)&&this.throttledGeocoder(t,_.bind(function(t,i){this.options.lat=t,this.options.lng=i,this.throttledDrawMaps(!0)},this))},this),{init:!1}),this["interface"].on("toggle",function(t,i){this.set(i,!this.get(i))}),this.drawMaps()},drawMaps:function(t){this.drawMap(t),this.drawMarker(),this.drawMinimap()},drawMap:function(t){t=t||!1;var i,o,e,a=this.getEl(".locator-map");a.id=this.id+"-map",e=[this.options.lat,this.options.lng,this.options.zoom],this.map&&!t?(e[0]=this.map.getCenter().lat,e[1]=this.map.getCenter().lng,e[2]=this.map.getZoom(),this.map.remove()):this.map&&this.map.remove(),i=_.size(this.options.widths)?this.options.widths[this.options.width]:a.getBoundingClientRect().width,o=_.size(this.options.ratios)?i/this.options.ratios[this.options.ratio]:a.getBoundingClientRect().height,a.style.width=i+"px",a.style.height=o+"px",this.map=new L.Map(a.id,{minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,attributionControl:!1}),this.map.setView([e[0],e[1]],e[2]),this.mapLayer=new L.TileLayer(this.options.tilesets[this.options.tileset]),this.map.addLayer(this.mapLayer)},drawMinimap:function(){var t,i=this.getEl(".locator-map").getBoundingClientRect().width,o=this.getEl(".locator-map").getBoundingClientRect().height,e=_.isNumber(this.options.miniWidth)?this.options.miniWidth:-1!==this.options.miniWidth.indexOf("w")?+this.options.miniWidth.replace("w","")/100*i:+this.options.miniWidth.replace("h","")/100*o,a=_.isNumber(this.options.miniHeight)?this.options.miniHeight:-1!==this.options.miniHeight.indexOf("w")?+this.options.miniHeight.replace("w","")/100*i:+this.options.miniHeight.replace("h","")/100*o;this.minimapLayer=new L.TileLayer(this.options.tilesets[this.options.tileset]),this.miniMap=new L.Control.MiniMap(this.minimapLayer,{width:e,height:a,zoomLevelOffset:this.options.miniZoomOffset,aimingRectOptions:{fill:!1,stroke:!1}}),this.map.addControl(this.miniMap),this.miniMap._miniMap.addLayer(this.drawMiniCanvasLayer(this.options.miniExtentStyles)),t=this.getEl(".locator-map .leaflet-control-minimap"),_.each(this.miniStylesToCSS(this.options.miniStyles),function(i,o){t.style[o]=i})},drawMiniCanvasLayer:function(t){return this.miniCanvasLayer=L.tileLayer.canvas(),this.miniCanvasLayer.drawTile=_.bind(function(i,o,e){var a=i.getContext("2d");a.clearRect(0,0,i.width,i.height);var n={};n.nwPoint=o.multiplyBy(256),n.sePoint=n.nwPoint.add(new L.Point(256,256)),n.nwCoord=this.map.unproject(n.nwPoint,e,!0),n.seCoord=this.map.unproject(n.sePoint,e,!0),n.bCoord=L.latLngBounds([[n.nwCoord.lat,n.seCoord.lng],[n.seCoord.lat,n.nwCoord.lng]]),n.bPoint=[n.nwPoint,n.sePoint];var s=this.map.getBounds(),r=this.map.project(s.getNorthWest(),e,!0),l=this.map.project(s.getSouthEast(),e,!0);a.beginPath(),a.rect(r.x-n.nwPoint.x,r.y-n.nwPoint.y,l.x-r.x,l.y-r.y),a=this.leafletStylesToCanvas(t,a),a.closePath()},this),this.map.on("moveend",_.bind(function(){this.miniCanvasLayer.redraw()},this)),this.miniCanvasLayer},drawMarker:function(){this.markerCanvas&&this.map&&this.map.removeLayer(this.markerCanvas),this.markerCanvas=L.tileLayer.canvas(),this.markerCanvas.drawTile=_.bind(this.drawMarkerTile,this),this.markerCanvas.addTo(this.map),this.draggableMarker&&this.map&&this.map.removeLayer(this.draggableMarker),this.draggableMarker=L.marker(L.latLng(this.options.lat,this.options.lng),{radius:10,draggable:!0,opacity:0,title:"Drag marker here"}).addTo(this.map),this.draggableMarker.on("dragstart",function(t){t.target.setOpacity(1)}),this.draggableMarker.on("dragend",_.bind(function(t){t.target.setOpacity(0);var i=t.target.getLatLng();this.options.lat=i.lat,this.options.lng=i.lng,this.drawMarker()},this))},drawMarkerTile:function(t,i,o){var e,a,n,s=t.getContext("2d"),r=.75*this.options.markerFontSize+2*this.options.markerPadding;s.clearRect(0,0,t.width,t.height);var l={};l.nwPoint=i.multiplyBy(256),l.sePoint=l.nwPoint.add(new L.Point(256,256)),l.nwCoord=this.map.unproject(l.nwPoint,o,!0),l.seCoord=this.map.unproject(l.sePoint,o,!0),l.bCoord=L.latLngBounds([[l.nwCoord.lat,l.seCoord.lng],[l.seCoord.lat,l.nwCoord.lng]]),l.bPoint=[l.nwPoint,l.sePoint],l.locCoord=L.latLng(this.options.lat,this.options.lng),l.locPoint=this.map.project(l.locCoord,o,!0),e={x:l.locPoint.x-l.nwPoint.x,y:l.locPoint.y-l.nwPoint.y},s.beginPath(),s.fillStyle=this.options.markerBackground,s.fillRect(e.x-this.options.markerRadius,e.y-this.options.markerRadius,2*this.options.markerRadius,2*this.options.markerRadius),s.closePath(),s.beginPath(),s.fillStyle=this.options.markerBackground,s.fillRect(e.x-this.options.markerLabelWidth/2,e.y-this.options.markerRadius-this.options.markerLabelDistance,this.options.markerLabelWidth,this.options.markerLabelDistance),s.closePath(),s.beginPath(),s.font=this.options.markerFontSize+"px "+this.options.markerFont,s.fillStyle=this.options.markerForeground,s.textAlign="center",a=s.measureText(this.options.markerText).width,n=a+2*this.options.markerPadding,s.closePath(),s.beginPath(),s.fillStyle=this.options.markerBackground,s.fillRect(e.x-n/2,e.y-this.options.markerRadius-this.options.markerLabelDistance-r,n,r),s.closePath(),s.beginPath(),s.font=this.options.markerFontSize+"px "+this.options.markerFont,s.fillStyle=this.options.markerForeground,s.textAlign="center",s.fillText(this.options.markerText,e.x,e.y-this.options.markerRadius-this.options.markerLabelDistance-this.options.markerPadding),s.closePath()},generate:function(){this.getEl(".locator-map .leaflet-control-zoom").style.display="none",this.getEl(".locator-map .leaflet-control-minimap").style.display="none",html2canvas(this.getEl(".locator-map"),{useCORS:!0,onrendered:_.bind(function(t){this.getEl(".locator-map .leaflet-control-zoom").style.display="block",this.getEl(".locator-map .leaflet-control-minimap").style.display="block",html2canvas(this.getEl(".locator-map .leaflet-control-minimap"),{useCORS:!0,onrendered:_.bind(function(i){var o=this.drawCanvasMiniMap(t,i);this.preview(o),this["export"](o)},this)})},this)})},drawCanvasMiniMap:function(t,i){var o=t.getContext("2d"),e=this.getEl(".locator-map .leaflet-control-minimap"),a=e.getBoundingClientRect().width,n=e.getBoundingClientRect().height,s=this.options.miniStyles,r=10,l=10;return o.beginPath(),o.fillStyle=s.backgroundColor,s.shadow&&(o.shadowColor=s.shadowColor,o.shadowBlur=s.shadowBlur,o.shadowOffsetX=s.shadowOffsetX,o.shadowOffsetY=s.shadowOffsetY),o.fillRect(o.canvas.width-r-a-2*s.padding,o.canvas.height-l-n-2*s.padding,a+2*s.padding,n+2*s.padding),o.closePath(),o.beginPath(),o.shadowColor=0,o.shadowBlur=0,o.shadowOffsetX=0,o.shadowOffsetY=0,o.drawImage(i,o.canvas.width-r-a-s.padding,o.canvas.height-l-n-s.padding,a,n),o.closePath(),o},preview:function(t){this.getEl(".preview img").src=t.canvas.toDataURL(),this.getEl(".preview").style.display="block"},"export":function(t){var i=this.getEl(".download-link");i.href=t.canvas.toDataURL(),i.download=_.uniqueId("locator_image-")+".png"},getEl:function(t){return document.querySelector(this.el+" "+t)},miniStylesToCSS:function(t){var i={"background-color":t.backgroundColor,border:t.padding+"px solid "+t.backgroundColor};return t.shadow&&(i["box-shadow"]=t.shadowOffsetX+"px "+t.shadowOffsetY+"px "+t.shadowBlur+"px "+t.shadowColor),i},leafletStylesToCanvas:function(t,i){return t.fill&&(i.globalAlpha=t.fillOpacity||1,i.fillStyle=t.fillColor||t.color,i.fill(t.fillRule||"evenodd")),t.stroke&&0!==t.weight&&(i.globalAlpha=t.opacity||1,i.strokeStyle=t.color,i.lineCap=t.lineCap,i.lineJoin=t.lineJoin,i.stroke()),i},defaultGeocoder:function(t,i){var o=new XMLHttpRequest,e="https://maps.googleapis.com/maps/api/geocode/json?address="+encodeURIComponent(t),a=_.once(i);o.onreadystatechange=function(){var t;200===o.status&&o.responseText&&(t=JSON.parse(o.responseText),t&&t.results&&t.results.length&&a(t.results[0].geometry.location.lat,t.results[0].geometry.location.lng))},o.open("GET",e),o.send()}}),window.Locator=t}();